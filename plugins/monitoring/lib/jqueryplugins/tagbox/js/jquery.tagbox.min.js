(function($){$.fn.tagbox=function(options){options.taglist=options.taglist||[];options.selectedlist=options.selectedlist||[];options.cols=options.cols||5;options.expand=options.expand||false;options.matrixlabel=options.matrixlabel||'Click here to see all available choices <span class="tagbox-matrix-label-arrow">[+]</span>';options.matrixaltlabel=options.matrixaltlabel||'Click here to close the choices list <span class="tagbox-matrix-label-arrow">[&minus;]</span>';options.maxtags=options.maxtags||0;options.placeholder=options.placeholder||"Select one or more...";var $el=div({"class":"tagbox"}),$input=input({"class":"tagbox-field-input",placeholder:options.placeholder}),$dropdown=div({"class":"tagbox-dropdown"}),$inputwrap=div({"class":"tagbox-input-wrapper"}).append($input,$dropdown),$field=div({"class":"tagbox-field"}).append($inputwrap),$matrix=div({"class":"tagbox-matrix"}),$matrixlabel=div({"class":"tagbox-matrix-label"}).html(options.matrixlabel),matching_tags=[],matching=false,selected=[];width=$(this).width()>0?$(this).width()-12:$(this).parent().width()-12;$matrix.width(width);$el.append($field,$matrixlabel,$matrix);$(this).append($el);$matrix.slideUp(0);$matrixlabel.click(function(){$matrixlabel.html(options.matrixlabel==$matrixlabel.html()?options.matrixaltlabel:options.matrixlabel);options.expand=!options.expand;options.expand?$matrix.slideDown("fast",function(){$dropdown.slideUp(0)}):$matrix.slideUp("fast")});if(options.expand){options.expand=!options.expand;$matrixlabel.click()}$dropdown.slideUp(0);for(var ix in options.taglist){$dropdown.append(clickable_tag(ix).slideUp(0));$matrix.append(matrix_item(ix));$(".tagbox-matrix-item",$matrix).css({width:$matrix.width()/(options.cols+.2)})}var initlist=options.selectedlist;while(initlist.length)add_to_selected(options.taglist.indexOf(initlist.pop()));$input.keyup(function(event){var e=event.originalEvent,str=$input.val();match_tags(str);$(".tagbox-matching").removeClass("tagbox-matching");$(".tagbox-clickable-tag",$matrix).each(function(ix,el,arr){$(el).text(options.taglist[$(el).data("tag-ix")])});if(matching){$dropdown.children().each(function(ix,el,arr){if($(el).data("tag-ix")in matching_tags){$(el).html(matching_tags[ix].html).slideDown("fast").addClass("tagbox-matching");$($(".tagbox-clickable-tag",$matrix)[ix]).html(matching_tags[ix].html).addClass("tagbox-matching")}else{$(el).slideUp("fast")}});options.expand||$dropdown.slideDown("fast")}else{if(e.which==32)$input.fadeOut("fast",function(){$input.val("");$input.show()});$dropdown.slideUp("fast");$(".tagbox-clickable-tag.selected",$el).removeClass("selected")}});$input.keydown(function(event){var e=event.originalEvent;if(e.which==38||e.which==40){e.preventDefault();if(!matching)return;var dir=e.which-39,$items=$(".tagbox-matching:visible",$el),$selected=$(".tagbox-clickable-tag.selected").removeClass("selected"),selector_ix=$items.index($selected),ix=dir+selector_ix;if(ix>=$items.length)ix=0;if(ix<0)ix=$items.length-1;$($items[ix]).addClass("selected")}else if(e.which===8){$input.val().length||remove_from_selected($(".tagbox-selected-tag",$el).last().data("tag-ix"))}else if(e.which==13){var ix=$(".tagbox-clickable-tag.selected").data("tag-ix");if(ix||ix===0)add_to_selected(ix);else if(!add_if_exact()){$input.val($input.val()+" ");$input.fadeOut("fast",function(){$input.val("");$input.show()});$dropdown.slideUp("fast")}}else if(e.which==32){add_if_exact(true)&&e.preventDefault()}});$(".tagbox-matrix-checkbox").change(function(){var ix=$(this).data("tag-ix");$(this).prop("checked")?add_to_selected(ix):remove_from_selected(ix)});return $el;function add_if_exact(single){single=single||false;var exact=-1,cnt=0;for(var ix in matching_tags){if(exact==-1)exact=matching_tags[ix].exact&&ix;cnt++}if(parseInt(exact,10)>-1&&(!single||single&&cnt==1)){add_to_selected(exact);return true}return false}function repopulate_selected(){options.selectedlist=[];for(ix in selected)options.selectedlist.push(options.taglist[ix]);$el.data("selected",options.selectedlist)}function add_to_selected(ix){if(options.maxtags&&options.selectedlist.length>=options.maxtags){remove_from_selected(ix);return}if(!ix||!(ix>=0&&ix<options.taglist.length)||selected[ix])return;selected[ix]=selected_tag(ix);$input.val("");$inputwrap.before(selected[ix]);$(".tagbox-matrix-checkbox",$matrix)[ix].checked=true;repopulate_selected();$el.trigger("tagAdded",[options.taglist[ix],options.selectedlist])}function remove_from_selected(ix){if(!selected[ix])return;selected[ix].animate({width:0,padding:0,opacity:0},"fast",$.proxy(function(){this.remove()},selected[ix]));delete selected[ix];$($(".tagbox-matrix-checkbox")[ix]).prop("checked",false);$input.val("");repopulate_selected();$el.trigger("tagRemoved",[options.taglist[ix],options.selectedlist])}function selected_tag(ix){return div({"class":"tagbox-selected-tag"}).data("tag-ix",ix).html(options.taglist[ix]).append(span({"class":"tagbox-selected-tag-remove"}).html("&nbsp;&times;").click(function(){remove_from_selected($(this).parent().data("tag-ix"))}))}function clickable_tag(ix){return div({"class":"tagbox-clickable-tag"}).data("tag-ix",ix).click(function(e){add_to_selected($(this).data("tag-ix"));$dropdown.slideUp("fast")})}function matrix_item(ix){return div({"class":"tagbox-matrix-item"}).data("tag-ix",ix).append(input({"class":"tagbox-matrix-checkbox",type:"checkbox"}).data("tag-ix",ix),div({"class":"tagbox-matrix-tag"}).append(clickable_tag(ix).text(options.taglist[ix])))}function match_tags(str){matching_tags=[];matching=false;if(!str)return;for(var ix in options.taglist){var tag=options.taglist[ix],pos=tag.toLowerCase().indexOf(str.toLowerCase()),txt=[tag.slice(0,pos),tag.substr(pos,str.length),tag.slice(pos+str.length)];if(pos>-1&&!(ix in selected)){matching=true;matching_tags[ix]={html:txt[0]+span({"class":"tagbox-match"}).text(txt[1]).outerHTML()+txt[2],exact:str.toLowerCase()==tag.toLowerCase()}}}}};function div(attr){return $(document.createElement("div")).attr(attr)}function input(attr){return $(document.createElement("input")).attr(attr)}function span(attr){return $(document.createElement("span")).attr(attr)}})(jQuery);jQuery.fn.outerHTML=function(s){return s?this.before(s).remove():jQuery("<p>").append(this.eq(0).clone()).html()};